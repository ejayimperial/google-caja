<html>
<head>
<title>Micro benchmark</title>
<script type=text/javascript src=fsm.js></script>
<script type=text/javascript src=../string-interpolation.js></script>
<script type=text/javascript src=html.js></script>
<script type=text/javascript>
if (!Date.now) { Date.now = function () { return (new Date).getTime(); }; }

var x = 'foo';

function esc(s) {
  return x.replace(/</g, '&gt;').replace(/>/g, '&lt;').replace(/&/g, '&amp;');
}

function stringPlusEquals(n) {
  var s = '<table>';
  for (var i = 0; i < n; ++i) {
    s += '<tr><td>' + esc(x) + '<td>' + esc(x) + '<td>' + esc(x) + '<td>'
       + esc(x);
  }
  s += '</table>';
  return s;
}

function stringArrayJoin(n) {
  var buf = [];
  buf.push('<table>');
  for (var i = 0; i < n; ++i) {
    buf.push(
        '<tr><td>', esc(x), '<td>', esc(x), '<td>', esc(x), '<td>', esc(x));
  }
  buf.push('</table>');
  return buf.join('');
}

function openTemplate1(n) {
  var template = open(Template("<table>"));
  for (var i = 0; i < n; ++i) {
    template.append(open(Template("<tr><td>$x<td>$x<td>$x<td>$x")));
  }
  template.append(open(Template("</table>")));
  return safeHtml(template);
}

function openTemplate2(n) {
  var template = new StringInterpolation(['<table>', '']);
  for (var i = 0; i < n; ++i) {
    template.args.push('<tr><td>', x, '<td>', x, '<td>', x, '<td>', x);
  }
  template.args.push('</table>');
  return safeHtml(template);
}

function domAppend(n) {
  var table = document.createElement('table');
  for (var i = 0; i < n; ++i) {
    var row = document.createElement('tr');
    var cell;
    cell = document.createElement('td');
    cell.appendChild(document.createTextNode(x));
    row.appendChild(cell);
    cell = document.createElement('td');
    cell.appendChild(document.createTextNode(x));
    row.appendChild(cell);
    cell = document.createElement('td');
    cell.appendChild(document.createTextNode(x));
    row.appendChild(cell);
    cell = document.createElement('td');
    cell.appendChild(document.createTextNode(x));
    row.appendChild(cell);
    table.appendChild(row);
  }
  return table;
}

function time(fn, runs) {
  var t0 = Date.now();
  fn(runs);
  var t1 = Date.now();
  return t1 - t0;
}

var benchmarks = [ { runs: 1000 }, { runs: 5000 } ];

for (var i = 0; i < benchmarks.length; ++i) {
  var benchmark = benchmarks[i];
  benchmark.string_plus_equals
      = time(stringPlusEquals, benchmark.runs);
  benchmark.string_array_join
      = time(stringArrayJoin, benchmark.runs);
  benchmark.string_open_template_1
      = time(openTemplate1, benchmark.runs);
  benchmark.string_open_template_2
      = time(openTemplate2, benchmark.runs);
  benchmark.dom_append
      = time(domAppend, benchmark.runs);
}

</script>
</head>

<body>
<div id=testbed></div>
<table cellspacing=4><tbody id=results><tr>
  <th># rows
  <th>string +=
  <th>Array.join
  <th>open(Template(&hellip;))
  <th>open(Template(&hellip;)) 2
  <th>DOM
  <th>render time
</tbody>
</table>
<script type=text/javascript>
(function () {
  var fields = ['string_plus_equals', 'string_array_join',
                'string_open_template_1', 'string_open_template_2',
                'dom_append'];
  var resultsTable = document.getElementById('results');
  var testDiv = document.getElementById('testbed');

  function go(j) {
    if (j >= benchmarks.length) { return; }

    var row = document.createElement('tr');
    var cell = document.createElement('td');
    cell.appendChild(document.createTextNode('' + benchmarks[j].runs));
    row.appendChild(cell);

    var html = stringPlusEquals(benchmarks[j].runs);
    var t0 = Date.now();
    testDiv.innerHTML = html;

    setTimeout(finish, 0);

    function finish() {
      var t1 = Date.now();
      testDiv.innerHTML = '';
      var renderTime = t1 - t0;
    
      for (var i = 0; i < fields.length; ++i) {
        cell = document.createElement('td');
        var time = benchmarks[j][fields[i]];
        cell.appendChild(document.createTextNode(time + ' ms'));
        row.appendChild(cell);
      }

      cell = document.createElement('td');
      cell.appendChild(document.createTextNode(renderTime + ' ms'));
      row.appendChild(cell);

      resultsTable.appendChild(row);

      setTimeout(function () { go(j + 1) }, 0);
    }
  }

  go(0);
})();
</script>
</body>
</html>
